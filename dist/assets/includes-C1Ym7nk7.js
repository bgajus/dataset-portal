(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function r(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=r(o);fetch(o.href,a)}})();const C={"portal-header":"/components/header.html","portal-footer":"/components/footer.html"},S="constellation:user:v1",A="constellation:role:v1",v="constellation:notifications:v1";function u(t){const e=String(t||"").trim().toLowerCase();return e==="curator"?"Curator":e==="admin"?"Admin":"Submitter"}function D(t){return String(t||"").split(",").map(e=>u(e)).filter(Boolean)}function l(){try{const t=localStorage.getItem(A);return u(t||"Submitter")}catch{return"Submitter"}}function O(t){try{return localStorage.setItem(A,u(t)),!0}catch(e){return console.warn("Failed to save role:",e),!1}}function U(t){const e=l(),r=D(t);return!r.length||e==="Admin"||r.includes("Submitter")?!0:r.includes(e)}function b(t){if(!t)return;t.dataset.role=l(),t.querySelectorAll("[data-requires-role]").forEach(r=>{const n=r.getAttribute("data-requires-role");r.hidden=!U(n)});const e=t.querySelector("[data-role-label]");e&&(e.textContent=l())}function f(){try{const t=localStorage.getItem(v),e=t?JSON.parse(t):[];return Array.isArray(e)?e:[]}catch{return[]}}function g(t){try{localStorage.setItem(v,JSON.stringify(Array.isArray(t)?t:[]))}catch(e){console.warn("Failed to write notifications:",e)}}function _({toRole:t,toEmail:e,title:r,message:n,href:o,recordDoi:a,kind:i}={}){const s=new Date().toISOString(),d={id:`${Date.now()}-${Math.random().toString(16).slice(2)}`,createdAt:s,read:!1,toRole:u(t||"Submitter"),toEmail:String(e||"").trim(),title:String(r||"Notification"),message:String(n||""),href:String(o||""),recordDoi:String(a||""),kind:String(i||"info")},y=f();return y.unshift(d),g(y),m(),d}function c(){return{firstName:"Brian",middleName:"",lastName:"Gajus",email:"",affiliation:"",orcid:"",avatarDataUrl:""}}function h(){try{const t=localStorage.getItem(S);if(!t)return c();const e=JSON.parse(t);return!e||typeof e!="object"?c():{...c(),...e}}catch{return c()}}function q(t){const e=String(t?.firstName||"").trim(),r=String(t?.lastName||"").trim(),n=e?e[0].toUpperCase():"",o=r?r[0].toUpperCase():"";return n+o||"??"}function E(){const t=h(),e=document.getElementById("avatarInitials"),r=document.getElementById("avatarImg");e&&(e.textContent=q(t));const n=!!String(t.avatarDataUrl||"").trim();r&&(n?(r.src=t.avatarDataUrl,r.alt=`${String(t.firstName||"").trim()} ${String(t.lastName||"").trim()}`.trim()||"User avatar",r.hidden=!1,e&&(e.hidden=!0)):(r.removeAttribute("src"),r.alt="",r.hidden=!0,e&&(e.hidden=!1)))}function N(){let t=null;try{t=localStorage.getItem("dp-auth")}catch{}if(t!=null){const n=String(t).toLowerCase();return n==="true"||n==="1"||n==="yes"}const r=(document.body?.dataset?.auth??"false").toString().toLowerCase();return r==="true"||r==="1"||r==="yes"}function L(t,e){t&&(t.dataset.auth=e?"true":"false",t.querySelectorAll('[data-requires-auth="true"]').forEach(r=>{r.hidden=!e}),t.querySelectorAll('[data-requires-auth="false"]').forEach(r=>{r.hidden=e}))}function x(t){const e=document.createElement("template");return e.innerHTML=t,Array.from(e.content.childNodes)}async function B(t,e){const r=(e||"").trim(),n=C[r];if(!n){console.warn(`[includes] Unknown include key: "${r}"`);return}const o=await fetch(n,{cache:"no-cache"});if(!o.ok){console.warn(`[includes] Failed to load ${n} (${o.status})`);return}const a=await o.text();if(!a||!a.trim()){console.warn(`[includes] Loaded ${n} but it was empty.`);return}const i=x(a),s=document.createElement("div");i.forEach(d=>s.appendChild(d.cloneNode(!0))),L(s,N()),b(s);const p=Array.from(s.childNodes);t.replaceWith(...p)}function I(){const t=window.location.pathname;document.querySelectorAll(".portal-authnav__item[data-path], .usa-menu__link[data-path]").forEach(r=>{const n=r.getAttribute("data-path");r.classList.remove("is-active"),r.removeAttribute("aria-current"),n&&t.includes(n)&&(r.classList.add("is-active"),r.setAttribute("aria-current","page"))})}function k(){const t=document.getElementById("avatarBtn"),e=document.getElementById("userMenu");if(!t||!e)return;function r(){const n=t.getAttribute("aria-expanded")==="true";t.setAttribute("aria-expanded",String(!n)),e.hidden=n,n||setTimeout(()=>{const o=e.querySelector("a");o&&o.focus()},0)}t.addEventListener("click",r),document.addEventListener("click",n=>{!t.contains(n.target)&&!e.contains(n.target)&&(t.setAttribute("aria-expanded","false"),e.hidden=!0)}),document.addEventListener("keydown",n=>{n.key==="Escape"&&!e.hidden&&(t.setAttribute("aria-expanded","false"),e.hidden=!0,t.focus())}),document.getElementById("signOutBtn")?.addEventListener("click",()=>{try{localStorage.setItem("dp-auth","false")}catch{}window.location.href="/index.html"})}function P(){const t=l(),e=String(h()?.email||"").trim().toLowerCase();return f().filter(r=>{if(!r||!(u(r.toRole)===t))return!1;const o=String(r.toEmail||"").trim().toLowerCase();return o?o===e:!0})}function R(){return P().filter(t=>!t.read).length}function m(){const t=document.getElementById("notifBadge");if(!t)return;const e=R();t.hidden=e<=0,t.textContent=String(e)}function F(t){const r=f().map(n=>n?.id===t?{...n,read:!0}:n);g(r),m()}function M(){const e=f().map(r=>({...r,read:!0}));g(e),m()}async function w(){const t=N(),e=Array.from(document.querySelectorAll("[data-include]"));await Promise.all(e.map(r=>B(r,r.getAttribute("data-include")))),L(document.body,t),b(document.body),document.querySelectorAll("[data-footer-year]").forEach(r=>{r.textContent=String(new Date().getFullYear())}),I(),k(),E(),m()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",w):w();window.addEventListener("popstate",I);window.DatasetPortal=window.DatasetPortal||{};window.DatasetPortal.setAuth=function(e){try{localStorage.setItem("dp-auth",e?"true":"false")}catch{}window.location.reload()};window.DatasetPortal.getUserProfile=function(){return h()};window.DatasetPortal.saveUserProfile=function(t){try{const e={...c(),...t||{}};return localStorage.setItem(S,JSON.stringify(e)),E(),!0}catch(e){return console.warn("Failed to save user profile:",e),!1}};window.DatasetPortal.getRole=function(){return l()};window.DatasetPortal.setRole=function(t){const e=O(t);return e&&window.location.reload(),e};window.DatasetPortal.notifications={add:_,listForMe:P,markRead:F,markAllRead:M,unreadCount:R};
